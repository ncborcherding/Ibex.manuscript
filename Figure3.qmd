---
title: "Figure 3"
format: html
editor: visual
author: "Nick Borcherding"
date: "7/23/24"
---

## Loading Libraries

```{r}
library(Seurat)
library(scRepertoire)
library(patchwork)
library(ggplot2)
library(viridis)
library(dplyr)
library(SingleR)
library(Azimuth)
library(scDblFinder)
library(harmony)
library(RColorBrewer)
library(Nebulosa)
library(mumosa)
library(Ibex)
library(stringr)

HPCA <- HumanPrimaryCellAtlasData()
```

## Loading and Filtering Single-Cell Data

```{r}
SC.Files <- list.files("./data/BEAM.AB/Dugan2021/Recovered/")
lapply(SC.Files, function(x) {
      tmp <- Read10X(data.dir = paste0("./data/BEAM.AB/Dugan2021/Recovered/", x))
      
      
      SeuratObj <-  CreateSeuratObject(counts = tmp[[1]], 
                               project = x, 
                               min.cells = 3, 
                               min.features = 200)
      
      SeuratObj$nCount_RNA <- colSums(SeuratObj@assays$RNA$counts)
      SeuratObj$nFeature_RNA <- colSums(SeuratObj@assays$RNA$counts != 0)
      
      #Attaching the BEAM-Ab data to single-cell object
      BEAM <- tmp[[2]][,colnames(tmp[[2]]) %in% rownames(SeuratObj@meta.data)]
      BEAM <- CreateAssayObject(counts = BEAM)
      SeuratObj[["BEAM"]] <- BEAM
      SeuratObj$nCount_BEAM <- colSums(SeuratObj@assays$BEAM$counts)
      SeuratObj$nFeature_BEAM <- colSums(SeuratObj@assays$BEAM$counts != 0)
      
      #Adding Sample Acession to barcodes
      new.names <- paste0(x, "_", colnames(SeuratObj))
      SeuratObj <- RenameCells(SeuratObj, new.names = new.names)
      
      #Calculating percentage of Genes
      SeuratObj[["percent.ribo"]] <- PercentageFeatureSet(SeuratObj, pattern = "^RPS|RPL-")
      SeuratObj[["percent.mt"]] <- PercentageFeatureSet(SeuratObj, pattern = "^MT-")
      
      #Filtering the Data Set for QC Metrics
      standev <- sd(log(SeuratObj$nFeature_RNA))*2.5 #cutting off above standard deviation of 2.5
      mean <- mean(log(SeuratObj$nFeature_RNA))
      cut <- round(exp(standev+mean))
      SeuratObj <- subset(SeuratObj, subset = percent.mt < 10 & nFeature_RNA < cut)
    
      ###########################################
      #Estimate Doublets for Each Sequencing Run
      ############################################
      sce <- as.SingleCellExperiment(SeuratObj)
      sce <- scDblFinder(sce)
      doublets <- data.frame(db.class = sce$scDblFinder.class, db.score = sce$scDblFinder.score)
      rownames(doublets) <- rownames(sce@colData)
      SeuratObj <- AddMetaData(SeuratObj, doublets)
  
      #######################
      #Adding BCR information
      #######################
      
      contigs <- read.csv(paste0("./data/BEAM.AB/Dugan2021/Recovered/", x, "/filtered_contig_annotations.csv.gz"))
      combined.BCR <- combineBCR(contigs,
                               samples = x)
      SeuratObj <- combineExpression(combined.BCR, SeuratObj)
    
      ###########################################
      #Seurat Azimuth Annotation
      ############################################
      AziObject <- NormalizeData(SeuratObj , verbose = FALSE)
      AziObject <- ScaleData(AziObject , verbose = FALSE)
      AziObject <- FindVariableFeatures(AziObject , nfeatures = 2500)
      VariableFeatures(AziObject ) <- VariableFeatures(AziObject )[-grep("^IG[HLK][VDJCGAMD]", VariableFeatures(AziObject ))]
      AziObject <- RunPCA(AziObject , verbose = FALSE)
      AziObject <- RunUMAP(AziObject , dims = 1:30, verbose = FALSE)
      AziObject <- FindNeighbors(object = AziObject , 
                           features = VariableFeatures(AziObject ), 
                           verbose = FALSE)
     
      AziObject <- RunAzimuth(AziObject, 
                              reference = "pbmcref",
                              verbose = FALSE)
     
      SeuratObj <- AddMetaData(SeuratObj, AziObject[[]])
        
      #############################################
      #Singler Annotation of Cell Types
      #############################################
        
      com.res1 <- SingleR(sce, ref=HPCA, labels=HPCA$label.fine, assay.type.test=1)
    
      df <- data.frame("labels" = com.res1$labels, "pruned.labels" = com.res1$pruned.labels)
      rownames(df) <- rownames(com.res1)
      colnames(df) <- paste0("HPCA.", colnames(df))
      SeuratObj <- AddMetaData(SeuratObj,  df)
      
      
      ####################################
      #Final Filter: Only B cells with BCR
      ####################################
      Bcells <- rownames(SeuratObj[[]])[which(SeuratObj[[]]$predicted.celltype.l1 == "B" & !is.na(SeuratObj$CTaa))]
      SeuratObj <- subset(SeuratObj, cells = Bcells)
      
      #Filtering out any cell without both IGH/L chain
      Bcells <- rownames(SeuratObj[[]])[!grepl("NA_|_NA", SeuratObj$CTaa)]
      SeuratObj <- subset(SeuratObj, cells = Bcells)
      
      SeuratObj
}) -> SeuratList

SeuratMerge <- merge(SeuratList[[1]], SeuratList[-1])
rm(SeuratList)
gc()
saveRDS(SeuratMerge, "./data/processed/Dugan2021_BEAM.ab_Recovered_Seurat.rds")
```

## Merging and Dimensional Reduction

```{r}

SeuratMerge <- JoinLayers(SeuratMerge)
DefaultAssay(SeuratMerge) <- "RNA"

all.genes <- rownames(SeuratMerge@assays$RNA$counts)
SeuratMerge  <- NormalizeData(SeuratMerge)
SeuratMerge  <- FindVariableFeatures(SeuratMerge, nfeatures = 2500)
VariableFeatures(SeuratMerge) <- VariableFeatures(SeuratMerge)[-grep("^IG[HLK][VDJCAGM]", VariableFeatures(SeuratMerge))]

SeuratMerge  <- SeuratMerge %>%
                  ScaleData(vars.to.regress = "percent.mt", 
                            features = all.genes, 
                            verbose = FALSE) %>%
                  RunPCA(features = VariableFeatures(SeuratMerge), 
                         verbose = FALSE)
SeuratMerge <- RunHarmony(SeuratMerge, "orig.ident")

SeuratMerge <- SeuratMerge %>%
                  FindNeighbors(reduction = "harmony") %>%
                  FindClusters(graph.name = "RNA_snn", algorithm = 4) 
        
SeuratMerge <- RunUMAP(SeuratMerge, 
                       reduction = "harmony", 
                       dims = 1:10)



saveRDS(SeuratMerge, "./data/processed/Dugan2021_BEAM.ab_Recovered_Seurat.rds")
```

## Figure 3A

Ploting UMAP and clusters

```{r}
#################
#Visualizing UMAP
#################

SeuratMerge <- readRDS("./data/processed/Dugan2021_BEAM.ab_Recovered_Seurat.rds")

Cluster.Pal <- colorRampPalette(brewer.pal(11, "Paired"))(length(unique(SeuratMerge$RNA_snn_res.0.8)))


plot3.A <- DimPlot(SeuratMerge, label = TRUE, repel = TRUE, label.size = 6, group.by = "RNA_snn_res.0.8") +
  scale_color_manual(values = Cluster.Pal) + 
  theme_void() + 
  theme(plot.title = element_blank()) + 
  NoLegend() 

ggsave("./outputs/Figure3/Figure3A.png", plot3.A, height = 4.5, width = 5, dpi = 300)

```

## Supplemental Figure Y

```{r}
features <- c("CD19", "CD27", "CD79A", "IGHM", "IGHD", "MKI67", "MS4A1", "XBP1")
DefaultAssay(SeuratMerge) <- "RNA"
density.plots <- plot_density(SeuratMerge, 
                              features = features, 
                              combine = FALSE, 
                              method = "wkde",
                              reduction = "umap") 

for(i in seq_along(density.plots)) {
  density.plots[[i]] <- density.plots[[i]] + 
                                  labs(title = NULL) + 
                                  guides(color = F) + 
                                  theme_void()
}


density.plots[[1]] + density.plots[[2]] + density.plots[[3]] + density.plots[[4]] + 
          density.plots[[5]] + density.plots[[6]] + density.plots[[7]] + density.plots[[8]] + plot_layout(ncol = 4)
ggsave("./outputs/Supplemental/FigureY.pdf", height = 9, width = 20)
```

## Figure 3B

Plotting the Ag probe density using the Nebulosa

```{r}
########################
#Visualizing BEAM Signal
########################

DefaultAssay(SeuratMerge) <- "BEAM"

SeuratMerge  <- NormalizeData(SeuratMerge, 
                              nomalization.method = "CLR",
                              margin = 1)
SeuratMerge  <- ScaleData(SeuratMerge,
                          use.umi = TRUE)


density.plots <- plot_density(SeuratMerge, 
                              features = rownames(SeuratMerge@assays$BEAM$counts)[c(5,4,2,1)], 
                              combine = FALSE, 
                              method = "wkde",
                              reduction = "umap") 

for(i in seq_along(density.plots)) {
  density.plots[[i]] <- density.plots[[i]] + 
                                  labs(title = NULL) + 
                                  guides(color = F) + 
                                  theme_void()
}


plot3.B <- density.plots[[1]] + density.plots[[2]] + density.plots[[3]] + density.plots[[4]] + plot_layout(ncol = 4)
ggsave("./outputs/Figure3/Figure3B.png", plot3.B, height = 4.5, width = 20, dpi = 300)
```

## Figure 3C

From [Dugan et al 2021 Methods](https://pubmed.ncbi.nlm.nih.gov/34022127/)

-   normalized antigen-probe binding signals, we arbitrarily set a threshold equal to 1 for all normalized probe signals to distinguish probe binding cells as "positive" or "negative."

-   Only cells whose top hit probe value was at least two-fold greater than their second hit probe value were clustered into the top hit probe-specific group; others were clustered into the "multi-reactive" group that indicates non-specific cells.

-   For samples in which we included separate SARS2 spike and RBD oligo tags, we placed cells positive to both SARS2 spike and SARS2 RBD into the "spike" group.

```{r}
###############################
#Assigning Epitope Specificity
##############################

epitopeMatrix <- as.matrix(SeuratMerge@assays$BEAM$scale.data[1:5,])

lapply(seq_len(ncol(epitopeMatrix)), function(x) {
  
  if(sort(epitopeMatrix[,x])[5] > 2*sort(epitopeMatrix[,x])[4] & sort(epitopeMatrix[,x])[5] > 1) {
    epi <- names(sort(epitopeMatrix[,x]))[5]
  } else {
    epi <- NA
  }
  epi
}) -> epitope.assignments
names(epitope.assignments) <- colnames(epitopeMatrix)
epitope.assignments <- as.data.frame(do.call(rbind, epitope.assignments))
colnames(epitope.assignments) <- "Epitope"
epitope.assignments$Epitope <- stringr::str_split(epitope.assignments$Epitope, "-", simplify = TRUE)[,2]
epitope.assignments$Epitope[epitope.assignments$Epitope == ""] <- NA
epitope.assignments$Epitope <- factor(epitope.assignments$Epitope, levels = c("NP", "ORF8", "RBD", "Spike"))

SeuratMerge <- AddMetaData(SeuratMerge, epitope.assignments)



plot3.C <- DimPlot(SeuratMerge, split.by = "Epitope", pt.size = 1.5, group.by = "RNA_snn_res.0.8") +
  scale_color_manual(values = Cluster.Pal) + 
  ggtitle(NULL) + 
  guides(color = F) + 
 theme(strip.background = element_blank(),
   strip.text.x = element_blank()) + 
  theme_void()

ggsave("./outputs/Figure3/Figure3C.png", plot3.C, height = 4.6, width = 20, dpi = 300)
```

## Figure 3D

```{r}
SeuratMerge$Spike.Specific <- "No"
SeuratMerge$Spike.Specific[SeuratMerge$Epitope %in% c("Spike", "RBD")] <- "Spike"
SeuratMerge$Heavy.V <- str_split(SeuratMerge$CTgene, "[.]", simplify = TRUE)[,1]
SeuratMerge$Light.V <- str_split(str_split(SeuratMerge$CTgene, "[_]", simplify = TRUE)[,2], "[.]", simplify = TRUE)[,1]
SeuratMerge$Heavy.C <- str_split(str_split(SeuratMerge$CTgene, "[.]", simplify = TRUE)[,4], "[_]", simplify = TRUE)[,1]
SeuratMerge$Light.C <- str_split(str_split(SeuratMerge$CTgene, "[_]", simplify = TRUE)[,2], "[.]", simplify = TRUE)[,3]

SeuratMerge  <- runIbex(SeuratMerge, 
                    chains = "Heavy",
                    method = "encoder",
                    encoder.model = "VAE", 
                    encoder.input = "AF", 
                    reduction.name = "Ibex.H.VAE.AF")


#Light Chain
SeuratMerge  <- runIbex(SeuratMerge, 
                    chains = "Light",
                    method = "encoder",
                    encoder.model = "VAE", 
                    encoder.input = "AF", 
                    reduction.name = "Ibex.L.VAE.AF")


reductions <- c("Ibex.H.VAE.AF", "Ibex.L.VAE.AF")
for (j in seq_along(reductions)) {
        if (j %in% 1:3) {
          vgene <- "Heavy.V"
        } else {
          vgene <- "Light.V"
        }
  
  non.duplicated <- unique(SeuratMerge@reductions[[reductions[j]]]@cell.embeddings)
  x <- phateR::phate(non.duplicated)
        
  plot.df <- data.frame(barcode = rownames(non.duplicated), x$embedding)
  plot.df$patient <- stringr::str_split(plot.df$barcode, "_", simplify = TRUE)[,1]
  plot.df <- merge(plot.df, SeuratMerge[[]], by.x = 1, by.y = 0)
        
  plot1 <- ggplot(plot.df, aes(x = PHATE1, y = PHATE2)) + 
                    geom_point(aes(color = orig.ident)) + 
                    scale_color_viridis(discrete = TRUE) + 
                    xlim(min(plot.df$PHATE1)*1.25, max(plot.df$PHATE1*1.25)) + 
                    ylim(min(plot.df$PHATE2)*1.25, max(plot.df$PHATE2)*1.25) + 
                    guides(color = "none") + 
                    theme_void()
        
  plot2 <- ggplot(plot.df, aes(x = PHATE1, y = PHATE2)) + 
                    geom_point(aes(color = plot.df[,vgene])) + 
                    scale_color_viridis(discrete = TRUE) + 
                    xlim(min(plot.df$PHATE1)*1.25, max(plot.df$PHATE1*1.25)) + 
                    ylim(min(plot.df$PHATE2)*1.25, max(plot.df$PHATE2)*1.25) + 
                    guides(color = "none") + 
                    theme_void()

  plot1 + plot2 
  ggsave(paste0("./outputs/Figure3/Figure3D_", reductions[j], ".png"), height = 5, width = 10, dpi = 600)
}
```

## Figure 3E

```{r}
output <- rescaleByNeighbors(
                  list(SeuratMerge[["Ibex.H.VAE.AF"]]@cell.embeddings, 
                       SeuratMerge[["pca"]]@cell.embeddings),
                  k =60)

phate_output <- phateR::phate(output)

colnames(output) <- paste0("c_Ibex", seq_len(ncol(output)))

SeuratMerge[["Trimodal.Embed"]] <- CreateDimReducObject(embeddings = as.matrix(output),
                                                        stdev = rep(0, ncol(output)),
                                                        assay = "RNA",
                                                        key = "Combined",
                                                        jackstraw = NULL,
                                                        misc = list())

SeuratMerge[["Trimodal.Phate"]] <- CreateDimReducObject(embeddings = phate_output$embedding,
                                                        stdev = rep(0, ncol(phate_output$embedding)),
                                                        assay = "RNA",
                                                        key = "TPhate",
                                                        jackstraw = NULL,
                                                        misc = list())

SeuratMerge <- FindNeighbors(SeuratMerge, 
                             reduction = "Trimodal.Embed", 
                             dims = 1:80, 
                             graph.name = c("Ibex_nn", "Ibex_snn"))
SeuratMerge <- FindClusters(SeuratMerge,
                            resolution = 0.5,
                            graph.name = "Ibex_snn",
                            algorithm = 4)

#######################################
#UMAP Comparisons between each approach
#######################################

plot.df <- data.frame(SeuratMerge[["Trimodal.Phate"]]@cell.embeddings, SeuratMerge[[]])

Cluster.Pal <- colorRampPalette(brewer.pal(11, "Paired"))(length(unique(SeuratMerge$Ibex_snn_res.0.5)))

        
plot1 <- ggplot(plot.df, aes(x = TPhate_1, y = TPhate_2)) + 
                    geom_point(aes(color = Ibex_snn_res.0.5)) + 
                    scale_color_manual(values = Cluster.Pal) + 
                    guides(color = "none") + 
                    theme_void()

plot2 <- ggplot(plot.df %>% arrange(Spike.Specific), aes(x = TPhate_1, y = TPhate_2)) + 
                    geom_point(aes(color = Spike.Specific)) + 
                    scale_color_viridis(discrete = TRUE) + 
                    guides(color = "none") + 
                    theme_void()

plot1 + plot2
ggsave(paste0("./outputs/Figure3/Figure3E.png"), height = 5, width = 10, dpi = 600)
```

## Saving Final File

```{r}
saveRDS(SeuratMerge, "./data/processed/Dugan2021_BEAM.ab_Recovered_Seurat.rds")
```

## Conclusions

```{r}
sessionInfo()
```
