---
title: "BEAM-Ab Analysis"
format: html
editor: visual
---

## Loading Libraries

```{r}
library(Seurat)
library(scRepertoire)
library(patchwork)
library(ggplot2)
library(viridis)
library(dplyr)
```

## Loading Single-Cell Data

```{r}
pbmc.data <- Read10X(data.dir = "./data/BEAM.AB/2k/raw_feature_bc_matrix")

pbmc <- CreateSeuratObject(counts = pbmc.data[[1]], 
                           project = "pbmc2k", 
                           min.cells = 3, 
                           min.features = 200)

#Attaching the BEAM-Ab data to single-cell object
BEAM <- pbmc.data[[2]][,colnames(pbmc.data[[2]]) %in% rownames(pbmc@meta.data)]
BEAM <- CreateAssayObject(counts = BEAM)
pbmc[["BEAM"]] <- BEAM
```

Processing Single-Cell Object

```{r}
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^mt-")
VlnPlot(pbmc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

plot1 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2

all.genes <- rownames(pbmc)

pbmc <- pbmc %>% 
          subset(subset = nFeature_RNA > 200 & nFeature_RNA < 3500 & percent.mt < 10) %>%
          NormalizeData(verbose = FALSE) %>%
          FindVariableFeatures(verbose = FALSE) %>%
          ScaleData(features = all.genes, verbose = FALSE) %>%
            RunPCA(features = VariableFeatures(pbmc), verbose = FALSE)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(pbmc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2


```

## Loading BCR Sequences

```{r}
contigs <- read.csv("./data/BEAM.AB/2k/2k_BEAM-Ab_Mouse_HEL_5pv2_Multiplex_vdj_b_all_contig_annotations.csv")
combined.BCR <- combineBCR(contigs,
                           samples = "S1")

combined.BCR <- lapply(combined.BCR, function(x) {
              x$barcode <- stringr::str_split(x$barcode, "_", simplify = TRUE)[,2]
              x
})
```
